document.write('<link rel="stylesheet" href="' + $("base").attr("href") + 'k/libs/poshytip/tip-yellow/tip-yellow.css" type="text/css" />'
		+'<link rel="stylesheet" type="text/css" href="' + $("base").attr("href") + 'pub/fileupload/css/fileupload.css" />');

//创建一个上传实例
function KHFileUploader(config){
	if(!window.plupload){
		$("head").append('<script type="text/javascript" src="pub/fileupload/js/plupload.js"></script>' +
			'<script type="text/javascript" src="pub/fileupload/js/plupload.flash.js"></script>' +
			'<script type="text/javascript" src="pub/fileupload/js/plupload.html5.js"></script>' +
			'<script type="text/javascript" src="k/libs/poshytip/jquery.poshytip.min.js"></script>');
	}
	
	this.fileUploaderRuntime = null;
	this.uploadRuntime = "html5,flash";
	this.uploadedFiles = [];//总共上传的文件
	this.singleUploadedFiles = [];//单次上传的文件
	var khUploader = this;
	
	//默认的配置
	this.uploadConfig = {
		fileId : "",//文件ID
		fileSize : "10mb",//文件大小限制
		businessId : "",//业务ID
		busUniqueName : "",//唯一业务名称
		folder: "",//业务指定文件存储目录
		buttonId : "pickfiles",//上传按钮ID
		container : "container",//上传控件容器ID
		fname : "",//自定义的存储文件名称
		title : "*",//文件选择框提示
		extName : "*",//文件扩展名限制
		useThirdDevice: false,//是否允许使用第三方扩展设备扫二维码上传
		thirdUploadTitle: "",
		saveDB : true,//是否往数据库写信息
		attType : "",//文件存储类型；1:数据库，0:磁盘，默认为磁盘
		workItem : "",//页面多点上传文件标识符号
		fileNum : 1,//限制上传文件数目
		remember: "0",//是否记住上传后保存。
		finishSave: function(files){},//保存调用的方法
		callback : function(files){},//上传成功后回调函数
		thirdUploadCallback: function(){},//第三方设备上传回调
		fileUploaded : function(file){},//单文件上传回调
		uploadProgress : function(file){},//上传进度回调，file={id:'',name:'',size:123,percent:33,status:''}
		filesAdded : function(files){},//添加文件事件,如果限制上传一个文件，files为单个文件，否则为选择的文件数组
		queueChanged : null,//上传队列发生变化,
		startAction : function(uploader){},//外部启动上传事件
		onError : function(errCoee){},//错误信息
		uploadError : function(file){}//上传失败
	};
	if(config){
		this.uploadConfig = $.extend(this.uploadConfig,config);
		/*$.each(config,function(k,v){
			if(v) khUploader.uploadConfig[k] = v;
		});*/
	}
	this.fileUploaderRuntime = new plupload.Uploader({
		runtimes : this.uploadRuntime,
		browse_button : this.uploadConfig.buttonId,
		container: this.uploadConfig.container,
		max_file_size : this.uploadConfig.fileSize,
		url : kFrameConfig.base + "fileupload/upload.do",
		flash_swf_url : kFrameConfig.base + 'pub/fileupload/js/plupload.flash.swf?ddd='+Math.random(),
		filters : [
			{title : this.uploadConfig.title, extensions : this.uploadConfig.extName}
		],
		multipart_params: {
			businessId: this.uploadConfig.businessId,
			saveDB: this.uploadConfig.saveDB,
			attType: this.uploadConfig.attType,
			folder: this.uploadConfig.folder,
			busUniqueName: this.uploadConfig.busUniqueName,
			workItem: this.uploadConfig.workItem,
			fileId: this.uploadConfig.fileId,
			fname: this.uploadConfig.fname
		}
	});
	
	this.setParams = function(params){
		var mparams = this.fileUploaderRuntime.settings.multipart_params;
		mparams = $.extend(mparams,params);
		this.fileUploaderRuntime.settings.multipart_params = mparams;
		
		/*if(param.businessId)
			url += "&businessId=" + param.businessId;
		if(param.saveDB)
			url += "&saveDB=" + param.saveDB;
		if(param.folder)
			url += "&folder=" + param.folder;
		if(param.attType)
			url += "&attType=" + param.attType;
		if(param.workItem)
			url += "&workItem=" + param.workItem;
		if(param.busUniqueName)
			url += "&busUniqueName=" + param.busUniqueName;
		if(param.fname)
			url += "&fname=" + param.fname;
		.url = url;*/
	}
	
	this.start = function(){
		khUploader.fileUploaderRuntime.start();
	}
	this.destory = function(){
		khUploader.fileUploaderRuntime.destroy();
	}
	this.destroy = this.destory;
	
	// ----------------------------------以下为绑定事件----------------------------------------
	
	//外部触发上传
	this.uploadConfig.startAction(this.fileUploaderRuntime);
	
	//添加文件事件
	this.fileUploaderRuntime.bind('FilesAdded', function(uploader, files) {
		if(khUploader.uploadConfig.fileNum > 0 && (khUploader.uploadedFiles.length + files.length > khUploader.uploadConfig.fileNum)){
			$.ligerDialog.alert("选择的文件太多，超过了限制！<br/>提示：您最多可上传【<b style='color:red'>" + khUploader.uploadConfig.fileNum + "</b>】个文件！");
			return false;
		}
		showProcessMsg(khUploader);
		if(khUploader.uploadConfig.filesAdded)
			return khUploader.uploadConfig.filesAdded(files);
	});

	//文件列表发生变化
	this.fileUploaderRuntime.bind('QueueChanged',function(uploader) {//上传队列发生变化
		if(khUploader.uploadConfig.queueChanged)
			khUploader.uploadConfig.queueChanged(uploader.files);
		else uploader.start();
	});
	
	//单个文件上传完成
	this.fileUploaderRuntime.bind('FileUploaded', function(uploader,file,resObj) {
		var json = $.parseJSON(resObj.response);
		if(json.success){//上传成功
			var fobj = json.data;
			fobj.upId = file.id;
			// 将上传的结果id放入某个指定的input元素中
			if(khUploader.uploadConfig["resultIdField"]){
			    var rstField = $("#"+khUploader.uploadConfig["resultIdField"]);
			    rstField.val((rstField.val() + "," + fobj.id).replace(/^,|,$/),"");
			}
			//{"id":json.data.id,"name":file.name,"path":json.data.path,"workItem":json.data.workItem,"upId":file.id};
			khUploader.singleUploadedFiles.push(fobj);
			khUploader.uploadedFiles.push(fobj);
			khUploader.uploadConfig.fileUploaded(fobj);
		}
		else{//上传失败
			khUploader.fileUploaderRuntime.stop();
			khUploader.uploadConfig.uploadError(file);
			khUploader.fileUploaderRuntime.refresh();
			$.ligerDialog.error(json.msg||"");
			file["extStatus"]=plupload.FAILED;
			
			//将已上传的文件删除
			$.each(khUploader.singleUploadedFiles,function(){
				$.getJSON('fileupload/deleteAtt.do?id='+this.id);
			});
			khUploader.singleUploadedFiles=[];
		}
	});

    //所有文件上传完成
    this.fileUploaderRuntime.bind("UploadComplete",function(uploader,files){
        $("body").unmask();
        khUploader.uploadConfig.callback(khUploader.singleUploadedFiles);
        khUploader.singleUploadedFiles = [];
        //上传文成处理事件 调用保存事件
        if(khUploader.uploadConfig.autoSave==1&&$("#issave").attr("checked")=="checked"){
            khUploader.uploadConfig.onComplete(upfiles);
        }
    });
    //文件上传进度变化
    window._isAutoSave=false;
    this.fileUploaderRuntime.bind("UploadProgress",function(uploader,file){
        khUploader.uploadConfig.uploadProgress(file);
        if(file["extStatus"] && file["extStatus"]==plupload.FAILED){
            $("body").unmask();
        	return;
        }
        var html = "正在上传【" + file.name + "】，完成 <span style='color: red; '>" + file.percent + "%</span>";
        if($("#_uploadProgressDiv").size()==0){
            $("#processDiv").html(html)
        }
        //todo 对原来代码注入性太强
        $("#_global_mask_div").show();
        $("#_global_mask_div_loading").show();
        $("#_uploadProgressDiv").html(html);
    });
    
	//发生错误时
	this.fileUploaderRuntime.bind('Error', function(uploader,error) {
		if(error.code == plupload.FILE_SIZE_ERROR){
			$.ligerDialog.alert("所选的文件【" + error.file.name + "】太大，超过了限制(" + uploader.settings.max_file_size/1024 + "KB)！");
		}
		else if(error.code == plupload.FILE_EXTENSION_ERROR){
			$.ligerDialog.alert("文件类型错误！<br/>提示：可以选择的文件类型为:"+uploader.settings.filters[0].extensions);
		}
		else if(error.code == plupload.INIT_ERROR){
			$.ligerDialog.alert("页面加载错误！<br/>您可以刷新本页面尝试解决问题。");
		}
		else{
			$.ligerDialog.alert("发生错误：" + error.code);
		}
		uploader.refresh();
        $("#_uploadProgressDiv").empty();
        $("body").unmask();
	});
	
	this.fileUploaderRuntime.init();

	//允许扫码上传
	if(this.uploadConfig.useThirdDevice){
		var $ubtn = $("#"+this.uploadConfig.buttonId).poshytip({
			alignTo: 'target',
			alignX: 'right',
			alignY: 'center',
			offsetX: 0,
			offsetY: 0,
			content: '<a id="' + this.uploadConfig.container 
				+ '-qrcode-picker-btn" class="third_upload_qrcode_picker"><span class="l-icon l-icon-qrcode" title="文件在手机上？您还可以点这里用手机APP扫码上传"></span></a>'
		});
		$("#" + this.uploadConfig.container + "-qrcode-picker-btn").live("click",function(){
			if($(".third_upload_qrcode_div").length > 0)return;
			$ubtn.poshytip("hide");
			$.post("service/upload/srv/start_third_upload.do?_r="+Math.random(),{
				title: khUploader.uploadConfig.thirdUploadTitle,
				workitem: khUploader.uploadConfig.workItem
			},function(response){
				if(!response.success){
					$.ligerDialog.alert("生成二维码失败！");
				}
				khUploader.openThirdUploadQrcode(response.data.qrcode,response.data.scode);
			},"json");
		});
	}
	
	this.startThirdUploadRollingCall = function(scode){
		window.setTimeout(function(){
			$.getJSON("service/upload/srv/rolling_get_files.do?scode="+scode,function(response){
				if(!response.success){
					$("#scode" + scode + " .qrcode").text("二维码已失效，请重新打开");
					return;
				}
				if(response.status >= 1 && (!response.data || response.data.length==0)){
					$(".qrcode_upload_tips").html('<img class="tips-icon" src="k/kui/images/indicator.gif"/>准备接收文件');
				}
				
				if(response.data && response.data.length > 0){
					var callfile;
					if(khUploader.uploadConfig.fileNum > 0 && khUploader.uploadConfig.fileNum<response.data.length){
						$("#third_upload_qrcode_close").click();
						$.ligerDialog.alert("文件上传过多，系统将会截取前【" + khUploader.uploadConfig.fileNum + "】个文件");
						callfile = [response.data[0]];
					}else{
						callfile = response.data;
					}
					$(".qrcode_upload_tips").html('<img class="tips-icon" src="k/kui/images/icons/16/check.png"/>已接收【' + callfile.length + '】个文件');
					if(khUploader.uploadConfig.thirdUploadCallback){
						khUploader.uploadConfig.thirdUploadCallback(callfile,scode);
					}
				}
				khUploader.startThirdUploadRollingCall(scode);
			});
		},3000);
	};
	
	this.openThirdUploadQrcode = function(encrypt,scode){
		var htmlstr = $("<div class='third_upload_qrcode_div' id='scode" + scode 
				+ "'><div class='head'>扫码上传<a class='close' id='third_upload_qrcode_close'>X</a></div><div class='qrcode'><img style='border:none;width:180px;height:180px;' src='data:image/png;base64," 
				+ encrypt + "'/></div><div class='qrcode_upload_tips'>请用手机、平板客户端APP扫描二维码上传文件，或者用手机、平板上的微信、QQ、浏览器等扫描二维码下载客户端APP。</div></div>");
		htmlstr.find("a.close").click(function(){
			$.getJSON("service/upload/srv/cancel_upload.do?scode="+scode);
			$(".third_upload_qrcode_bg_div").remove();
			$(".third_upload_qrcode_div").remove();
		});
		htmlstr.css({"left":$(window).width()/2-100,"right":$(window).height()/2-150});
		$("body").append(htmlstr);
		khUploader.startThirdUploadRollingCall(scode);
	};
	
	/**
	 * 从已上传的文件集合删除某个文件
	 */
	this.removeUploadFile = function(fid){
		var newfiles = [];
		$.each(this.uploadedFiles,function(){
			if(this.id != fid) newfiles.push(this);
		});
		this.uploadedFiles = newfiles;
	}
}

/*
 
  使用jquery plugin的方式实现上传功能。对原有的上传功能进一步封装，实现简单调用。

【使用及参数说明：】
--------------------------------------------------------------------------------------------------------------
使用jquery方法进行初始化，并获取空间对象（myUploader）
var myUploader = $("#element id").khUpload(params);
 	 1、参数element id 为上传区域的容器对象id
     2、参数params：
      {
    		fileSize : "10mb",//文件大小限制，默认10mb
			extName : "jpg,gif,jpeg,png,bmp,doc,pdf,docx,xlsx,xls,ppt,pptx,txt,rar,zip,7z",//文件扩展名限制，默认为*
			title : "*",//文件选择框提示文字
			fileNum : -1,//限制上传文件数目，默认-1
			useThirdDevice: true,//是否使用APP上传，默认为false
			thirdUploadTitle: "",//app上传提示文字
			edit: true, //是否编辑状态，默认使用页面<head>标签的pageStatus属性值
			preview: true,//是否使用小图片预览展示，默认为true
			container: 'xxxx-container-id',//自定义的上传plupload控件容器，默认为随机生成
			buttonId: 'xxxx-btn-id',//自定义的上传按钮id，默认为随机生成
			businessId: '业务ID', //，提供了业务id时，初始化后会自动加载次业务ID之前所有上传的文件，这在修改业务信息时有用
			workItem : "",//业务多点上传文件标识
			busUniqueName : "",//唯一业务名称
			folder: "",//业务指定文件存储目录
			fname : "",//自定义的存储文件名称
			saveDB : true,//是否往数据库写信息
			attType : "0"//文件存储类型；1:数据库，0:磁盘，默认为磁盘，在2.x平台版本之后，已不再写数据库，统一为磁盘
	   }

	所有参数均为可选，但是诸如文件大小、类型、数量这些应该还是有必要进行设定。APP上传也可以尽可能地使用（前提是移动设备可链接到服务器）。	   

【可用的API：】	   
--------------------------------------------------------------------------------------------------------------
   1、【方法】getUploadFiles：
		在上传过程中，业务不再需要使用回调函数处理，只需在必要的时候通过 myuploader.uploadFiles属性直接获取上传的文件数组即可。
   2、【方法】getUploadFileIdNames：
   		为了方便业务，还可以直接使用myuploader.getUploadFileIdNames()获取到所有附件的id和name的字符串连接结果（以逗号","分割）。
   3、【方法】loadFiles：
   		大多时候，业务只需要在页面初始化后进行一次初始化，然后通过myuploader.loadFiles(businessId)方法，加载之前已经上传过的文件
 */
(function($){
	$.KhUpload = function(elm,options){
		this.$elm = $(elm);
		this.uploader = null;
		this.uploadedFiles = [];//detail时暂存文件列表
		var $this = this;
		this.opts = $.extend({},options,{
			callback : function(files){
				$this._showFiles(files);
			}
		});
		this.init();
	};
	
	$.KhUpload.prototype = {
		// 删除文件处理，需要从已上传文件集合中移除文件
		_removeUploadFile : function(fid){
			var newFileArr = [];
			$.each(this.uploadedFiles,function(){
				if(this.id != fid){
					newFileArr.push(this);
				}
			});
			this.uploadedFiles = newFileArr;
			this.uploader.removeUploadFile(fid);
		},
		// 展示已上传文件，同时更新已上传文件数据集合
		_showFiles : function(fs,delCall){
			var $this = this;
			var ffs = [];
			if(this.opts.workItem){
				$.each(fs,function(){ 
					if(this.workItem == $this.opts.workItem)
						ffs.push(this);
				});
			}else{
				ffs = fs;
			}
			if(ffs.length==0) return;
			
			// 将新添加的文件信息追加到集合中
			this.uploadedFiles = this.uploadedFiles.concat(ffs);
			
			createFileViewList({
		        files: ffs,
		        edit: this.opts.edit,
		        ctrId: this.opts.container + "-files",
		        preview: this.opts.preview,
		        callback: function(fid){
		        	$this._removeUploadFile(fid);
		        	if(delCall) delCall(fid);
		        }
			});
		},
		// 加载所有已上传文件
		loadFiles : function(busId){
			var $this = this;
			getBusinessFiles(busId,this.opts.workItem,function(fs){
				if(fs.length < 1) return;
				$this._showFiles(fs);
			});
		},
		// 添加附件,用于业务自行添加
		addFiles: function(sfiles,delCall){
			this._showFiles(sfiles,delCall||function(){});
		},
		getUploadFileIdNames : function(){
			var returnVal = {id:"",name:""};
			if(this.uploadedFiles.length>0){
				$.each(this.uploadedFiles,function(){
					returnVal.id += "," + this.id;
					returnVal.name += "," + this.name;
				});
				returnVal.id = returnVal.id.substring(1);
				returnVal.name = returnVal.name.substring(1);
			}
			return returnVal;
		},
		init: function(){
			var $this = this;
			
			// 未指定容器、按钮，动态创建
			if(!this.opts["buttonId"]){
				var random = new Date().getTime();
				this.opts = $.extend({},this.opts,{
					buttonId : "plupload-add-button-" + random,
					container : "plupload-container-" + random
				});
			}
			
			//第三方上传处理
		    if(this.opts["useThirdDevice"]){
				this.opts.thirdUploadCallback = function(fs,scode){
					var newfiles = [];
					var fids = "";
					$.each(fs,function(){
						fids += this.id + ",";
						if($("#"+this.id).size()==0) newfiles.push(this);
					});
					if(newfiles.length == 0) return;
					
					// 检查文件数量，这里只对第三方设备上传有效，浏览器上传的在plupload中已处理
					if($this.opts.fileNum > 0 && ($this.uploadedFiles.length + newfiles.length > $this.opts.fileNum)){
						$.post("service/upload/srv/delete_file.do?ids=" + fids + "&scode=" + scode,function(){
							$.ligerDialog.alert("选择的文件太多，超过了限制！<br/>提示：您最多可上传【<b style='color:red'>" + $this.opts.fileNum + "</b>】个文件！");
						},"json");
						return;
					}
					
					$this._showFiles(newfiles, function(fid){
						$.post("service/upload/srv/delete_file.do?ids=" + fid + "&scode=" + scode,"json");
					});
				}
		    }
		    
		    // 建立容器
		    var $container = $("#" + this.opts.container);
		    if($container.size()==0) $container = $('<div id="' + this.opts.container + '"></div>').appendTo(this.$elm);
		    if(this.opts.edit){
		    	if($("#" + this.opts.buttonId).size()==0){
					var buttonHtml = this.opts.preview ? 
							'<div style="float:left;margin-right:5px;text-align:center;border-radius:5px;padding:0;cursor:pointer;width:52px;height:52px;font-size:42px;'
								+ 'line-height:46px;color:#999999;border:1px solid #BBBBBB;" id="' + this.opts.buttonId + '">+</div>'
							: '<a class="l-button" id="' + this.opts.buttonId + '" style="z-index:0;float:left;"><span class="l-button-main"><span class="l-button-text">选择文件</span></span></a>';
		    		$container.append(buttonHtml);
		    	} 
		    	// edit为true时进行plupload控件初始化
		    	this.uploader = new KHFileUploader(this.opts);
		    }
		    
		    // 文件列表展示框
		    if($("#" + this.opts.container + "-files").size()==0)
		    	$container.append('<ul class="upload-file-list l-upload-ok-list" id="' + this.opts.container + '-files"></ul>');
		    
		    // 加载已经上传的文件
		    if(this.opts["businessId"]){
				this.loadFiles(this.opts["businessId"]);
			}
		},
		setParams: function(params){
			if(this.opts.edit)
				this.uploader.setParams(params);
			
			//如果更新了business id，要重新刷附件
			if(params['businessId']) 
				this.loadFiles(params['businessId']);
		}
	};
	
	$.fn.khUpload = function(options) {
		if(!options){
			if($(this).data('khUpload'))
				return $(this).data('khUpload');
		}
		
		if (typeof options == 'string') {
			var khUpload = $(this).data('khUpload');
			if (khUpload && khUpload[options])
				return khUpload[options]();
			else return;
		}
		
		var opts = $.extend({},$.fn.khUpload.defaults,options);
		
		var uploader = new $.KhUpload(this, opts);
		$(this).data('khUpload', uploader);
		return uploader;
	};
	
	$.fn.khUpload.defaults = {
		fileSize: "10mb",
		extName: "*",
		fileNum : -1,
		useThirdDevice: true,
	    preview: true,
	    edit: $("head").attr("pageStatus")=="add" || $("head").attr("pageStatus")=="modify" || $("head").attr("pageStatus")=="edit"
	};
})(jQuery);

function KHKuiFileuploader(myConfig){
	if(!myConfig || !myConfig.fileContainer){
		$.ligerDialog.alert("请指定附件容器！参数名称：fileContainer");
		return;
	}
	
	myConfig.fileUploaded = function(file){//单个回调函数
		if(file){
			$("#" + file.upId).find(".progress").addClass("l-icon-close").click(function(){
				deleteUploadFile(file.id,file.path,this,function(){
					if(myConfig.delCallback){
						myConfig.delCallback(file);
					}
				});
			});
			$("#" + file.upId).find("a").attr("href",kFrameConfig.base + "fileupload/download.do?id="+ file.id);
		}
	};
	
	myConfig.uploadProgress = function(file){//上传进度回调
		if(file.percent==100)
			$("#" + file.id).find(".progress").html("&nbsp;");
		else
			$("#" + file.id).find(".progress").html("<span>"+ file.percent + "%<span>");
	};
	
	myConfig.filesAdded = function(file){//添加文件到上传队列事件
		var htmlStr = "";
		if($.isArray(file)){
			$.each(file,function(i){
				htmlStr += '<li id="' + file[i].id + '"><div><a href="javascript:void();">' + file[i].name 
					+ '</a></div><div class="progress">&nbsp;</div></li>';
			});
		}
		else{
			htmlStr = '<li id="' + file.id + '"><div><a href="javascript:void();">' + file.name 
				+ '</a></div><div class="progress">&nbsp;</div></li>';
		}
		$("#" + myConfig.fileContainer).find(".file_list").append(htmlStr);
	};
	
	myConfig.container = myConfig.fileContainer + "_container";
	myConfig.buttonId = myConfig.fileContainer + "_pickfiles";
	
	//创建上传区域
	$("#" + myConfig.fileContainer).append('<p id="' + myConfig.container + '"><a class="l-button" id="' + myConfig.buttonId 
			+ '"><span class="l-button-main"><span class="l-button-text">选择文件</span></span></a></p>'
			+ '<div class="l-upload-ok-list"><ul class="file_list"></ul></div>');
	return new KHFileUploader(myConfig);
}

//删除服务器文件
function deleteUploadFile(id, path, obj, callback) {
    $.ligerDialog.confirm("确定删除文件？<p style='color:red'>注意：删除后不可恢复！</p>", function(flag) {
		if(flag){
			$("body").mask("正在删除，请稍后……");
		    $.getJSON('fileupload/deleteAtt.do',{"id":id,"path":path}, function(resp) {
		    	if(resp.success){
		    		if(obj){
		    			$(obj).parent().remove();
		    		}
		    		if(callback){
		    			callback(id,path);
		    		}
					$("body").unmask();
		    	}
		    	else{
					$("body").unmask();
		    		alert("删除失败！");
		    	}
		    });
		}
    });
}

function viewAttachment(id,name,container){
	var fname = name.toLowerCase();
	var regex = /\.(jpg|gif|png|bmp)$/gi;
	if(fname.match(regex) != null){
		var allFile = container?container.children():[];
		var previewData = {fisrt:0,images:[]};
		$.each(allFile, function(i) {
			var $id = $(this).attr("id");
			var $fname = $(this).attr("fname");
			if ($id == id) {
				previewData.first = (previewData.images.length == 0 ? 0 : previewData.images.length);
			}
			if($id == id || $fname.match(regex) != null){
				previewData.images.push({
					id : $id,
					name : $fname
				});
			}
		});
		top.winOpen({
			title: name,
			width: $(top).width(),
			height: $(top).height(),
			parent: window["api"]?window["api"]:null,
			resize: false,
			max: false,
			min: false,
			content: "url:pub/fileupload/preview.jsp",
			data: previewData
		});
	}
	else if(fname.match(/\.pdf$/gi) != null && !($.browser.msie && $.browser.version < 9.0)){		
        top.$.dialog({
            width: $(top).width(),
            height: $(top).height(),
            title: name,
            lock: false,
            reSize: false,
            content: "url:pub/pdfjs/viewer.jsp?fid=" + id
        });
	}
	else{
		window.open(kFrameConfig.base + "fileupload/download.do?id=" + id);
	}
}

//打开office文档
function openOfficeDocument(fid,fname,status){
    top.$.dialog({
        width: $(top).width(),
        height: $(top).height(),
        title: fname,
        lock: false,
        reSize: false,
        content: "url:pub/fileupload/ntko_editor.jsp",
        data: {fid:fid,status:status}
    });
}

// 在线播放视频
function playVideoOnline(fid,fname){
	top.$.dialog({
        width: $(top).width(),
        height: $(top).height(),
        title: fname,
        lock: false,
        reSize: false,
        data: {fid:fid, fname:fname},
        content: "url:pub/fileupload/video_player.jsp?fid=" + fid
    });
}

/**
 * 生成文件列表。
 * 这里要求文件数组的元素格式必须为{id:"",name:""}
 * @param fs 文件数组
 * @param edit 是否可编辑
 * @param ctrId 容器ID
 * @param preview 是否以预览图展示
 */
function createFilesView(fs,edit,ctrId,preview,callback){
    createFileViewList({
        files:fs,edit:edit,ctrId:ctrId,preview:preview,callback:callback
    })
}

/**
 * 创建一组文件列表视图，使用json格式参数
 * @param options
 */
function createFileViewList(options){
	$.each(options.files,function(){
	    var $ops = $.extend({fid:this.id,fname:this.name},options);
	    createFileViewItem($ops);
	});
}

/**
 * 生成单个文件视图
 * 
 * @param fid 文件id
 * @param fname 文件名
 * @param edit 是否可编辑
 * @param ctrId 容器ID
 * @param preview 是否以预览图展示
 */
function createFileView(fid,fname,edit,ctrId,preview,callback){
    createFileViewItem({
        fid:fid,fname:fname,edit:edit,ctrId:ctrId,preview:preview,callback:callback
    });
}

/**
 * 生成单个文件视图,采用json参数
 * 
 * @param options
 */
function createFileViewItem(options){
    var ctr = $(".l-upload-ok-list");
    if(options.ctrId) ctr = $("#" + options.ctrId);
    var fitem = $("<li id='" + options.fid + "' fname='" + options.fname + "' class='"+(options.preview?"preview":"not-preview") + "'></li>").appendTo(ctr);
    var ofpreview = options.fname.match(/\.(doc|docx|xls|xlsx)$/i) && kFrameConfig.previewOfficeDocument;
    var isVedio = options.fname.match(/\.(avi|mp4|wmv|mkv|rmvb)$/i);
    var fcontainer = $("<a class='f-link'></a>").appendTo(fitem);
    if(!ofpreview){
    	fcontainer.click(function(){
    		viewAttachment(options.fid,options.fname,ctr);
    	});
    }
    if(options.preview){
    	var previewImgAddr;
    	if(options.previewImg) previewImgAddr = options.previewImg;
    	else previewImgAddr = getPreviewImageAddr(options.fid,options.fname,true);
        fcontainer.append("<img width='48' height='48' src='" + previewImgAddr + "' />");
    }
    else{
        fcontainer.append("<img width='16' height='16' class='fname-icon' src='" + getPreviewImageAddr(options.fid,options.fname,false) + "' />" + options.fname);
    }
    if(options.edit){
        var d = $('<div class="l-icon-close progress">&nbsp;</div>');
        d.click(function(){
            deleteUploadFile(options.fid,"","",function(){
                $("#" + options.fid).remove();
                if(options.callback) options.callback(options.fid);
            });
        });
        d.appendTo(fitem)
    }
    if(options.preview || ofpreview || isVedio){
        fitem.on("mouseenter",function(){
            var tips = $("#upload-fname-tips");
            if(tips.size()==0){
                tips = $('<div class="upload-fname-tips" id="upload-fname-tips"><div class="tips-arrow-bg"></div><div class="tips-arrow"><div class="tips-arrow inner"></div></div>'+
                            '<div class="tips-head"></div><div class="tips-content"><div class="edit"><span class="l-icon l-icon-edit"></span><span class="text">编辑</span></div>'+
                            '<div class="view"><span class="l-icon l-icon-detail"></span><span class="text">查看</span></div>' + 
                            '<div class="down"><span class="l-icon l-icon-save"></span><span class="text">下载</span></div></div></div>');
            }
            tips.css("left","-100px").appendTo(fitem);
            $("#upload-fname-tips .tips-head").text(options.fname);
            if(ofpreview || isVedio){
                tips.removeClass("no-button");
                $("#upload-fname-tips .tips-content").show();
                if(options.modify && ofpreview){
                    tips.find(".tips-content .edit").show().off("click").on("click",function(){
                        openOfficeDocument(options.fid,options.fname,"edit");
                    });
                }else{
                    tips.find(".tips-content .edit").hide().off("click");
                }
                tips.find(".tips-content .view").show().off("click").on("click",function(){
                	if(ofpreview)
                		openOfficeDocument(options.fid,options.fname,"detail");
                	else
                		playVideoOnline(options.fid,options.fname);
                });
                tips.find(".tips-content .down").show().off("click").on("click",function(){
                    window.open($("base").attr("href") + "fileupload/download.do?id=" + options.fid);
                });
            }else{
                tips.addClass("no-button");
                $("#upload-fname-tips .tips-content").hide();
            }
            tips.show().css("bottom",options.preview?(ofpreview?"63px":"62px"):(ofpreview?"33px":"32px"));
            if(fitem.offset().left + fitem.width()/2-99 + tips.width()>$(window).width()){
                tips.css("left",fitem.width()-198+"px"); 
                tips.find(".tips-arrow").css("left","160px");
                tips.find(".inner").css("left","-10px");
            }else if(fitem.offset().left < 100){
                tips.css("left","0px");
                tips.find(".tips-arrow").css("left",fitem.width()/2-10 + "px");
                tips.find(".inner").css("left","-10px");
            }else{
                tips.css("left",(fitem.width()/2-99)+"px");
                tips.find(".tips-arrow").css("left","45%");
                tips.find(".inner").css("left","-10px");
            }
       });
       fitem.on("mouseleave",function(){
           $("#upload-fname-tips").off("mouseout").hide();
       });
    }
}

function createThirdUploadFileViewItem(options,scode){
	if($("#"+options.fid).size()>0) return;
	var myops = {};
	$.extend(myops,options,{callback:function(fid){
		$.post("service/upload/srv/delete_file.do?ids=" + fid + "&scode=" + scode,function(resp){
			if(options.callback) options.callback(fid);
		},"json");
	}});
	createFileViewItem(myops);
}

//获取与文件后缀名匹配的小图标地址
function getPreviewImageAddr(fid,fname,preview){
	if(preview && fname.match(/\.(jpg|gif|png|bmp)$/gi) != null){
		return kFrameConfig.base + "fileupload/previewImage.do?id=" + fid +"&_r="+Math.random();
	}else{
		var suffixIdx = fname.lastIndexOf(".");
		var suffix = suffixIdx==-1?"file":fname.substring(suffixIdx).toLowerCase().substring(1);
		// 从系统参数【文件后缀图标集合】中查找
		if(suffixIdx > -1 && window["kFrameConfig"] && kFrameConfig["suffixIcon"] && kFrameConfig.suffixIcon.indexOf(suffix)==-1)
	            suffix = "file";
		return "k/kui/images/file-type/"+(preview?48:16)+"/" + suffix + ".png";
	}
}

function getBusinessFiles(_bid,_item,_callback){
	var wim = $.kh.isNull(_item)?"":_item;
	$.getJSON("fileupload/busFiles.do?businessId=" + _bid+"&item=" + wim,function(resp){
		if(resp.success){
			_callback(resp.data);
		}else{
			$.ligerDialog.error("获取附件失败！");
		}
	});
}

/**
 * 获取业务附件
 * @param _bussid
 * @param _callback
 */
function getBusinessAttachments(_bussid,_callback){
	getBusinessFiles(_bussid,"",_callback)
}
function showProcessMsg(khUploader){
	var html = "<div id='processDiv'></div>";
	if($("#_uploadProgressDiv").size()==0){
        if (khUploader.uploadConfig.autoSave == 1) {
        	html+="<br><br><div id='_isSaveDiv' style='z-index:200'><input type='checkbox' id='issave'><label for='issave' style='margin-left:2px'>上传完成后，是否保存？</label></div>";
        }
    }
	$("#_global_mask_div_loading").html(html);
}
