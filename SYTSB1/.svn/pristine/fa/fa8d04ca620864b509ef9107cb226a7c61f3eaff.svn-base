<%@page import="com.khnt.security.util.SecurityUtil"%>
<%@ page contentType="text/html;charset=UTF-8"%>
<%@taglib uri="http://bpm.khnt.com" prefix="bpm" %>
<%@ taglib uri="http://khnt.com/tags/ui" prefix="u" %>
<%
String userId=SecurityUtil.getSecurityUser().getId();
%>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>报告录入</title>
<%@include file="/k/kui-base-list.jsp"%>
<script type="text/javascript" src="pub/selectUser/selectUnitOrUser.js"></script>
<script type="text/javascript" src="pub/bpm/js/util.js"></script>
<script type="text/javascript">
	var deviceClassify = <u:dict code="device_classify"/>;
	function getDeviceClassifyCode(text,arr){
		var re = "";
		for(var i=0;i<arr.length;i++){
			if(arr[i].text==text){
				re = arr[i].id;
			}else if(arr[i].children){
				re = getDeviceClassifyCode(text,arr[i].children);
			}
			if(re!=""){
				break;
			}
		}
		return re;
	}
	var w = window.screen.availWidth;
	var h = window.screen.availHeight;
	var userId = "<sec:authentication property='principal.id' htmlEscape='false' />";
	var	unitcode="";
	var type = "";
	var flow_num ="${param.flow_num}";
	var buff = "${param.function}";
	var bar =[];
	var top_name="";
	var type_name="";
	//报告录入
	if(buff.indexOf("_bglr")!=-1){
		if(buff.indexOf("dt_bglr")!=-1){
			bar = [
	 			{text : '报告录入', id : 'input', icon : 'modify', click : input}, "-",
				{text : '生成编号', id : 'addNum', icon : 'modify', click : addNum},"-",
				{text : '增加编制人', id : 'addEditor', icon : 'modify', click : addEditor},"-",
				{text : '打印信息表', id : 'printInfo', icon : 'print', click : printInfo}, "-",
	 			{text : '打印检验申请表', id : 'printApply', icon : 'print', click : printApply}, "-",
				{text : '打印资料归档目录', id : 'printEnd', icon : 'print', click : doPrintEnd},'-', 
				{text : '查看报告', id : 'showReport', icon : 'detail',  click : showReport},"-",
				{text : '查看原始记录', id : 'showRecord', icon : 'detail', click : showRecord},"-",
				{text : '查看质量资料', id:'showQuality',icon:'detail', click: showQuality},'-', 
				{text : '查看图片', id : 'showPics', icon: 'detail', click : showPics},'-', 
	 		    {text : '流转过程', id : 'flow_note', icon:'follow', click : getFlow},"-",
				{text : '报告复制', id : 'copy', icon : 'copy', click : copy},"-",
				{text : '同步设备信息', id : 'updateDevices', icon : 'modify', click : updateDevices},"-",
				{text : '提交审核', id : 'copy', icon : 'search', click : validation},"-",
				{text : '提交记录', id : 'subHistory', icon : 'detail', click : subHistory},"-",
				{text : '报告作废', id : 'del', icon : 'delete', click : del},"-",
				{text : '退回', id : 'backINfo', icon : 'back', click : reportBackINfo},"-",
				{text : '上传附件', id : 'upload', icon :'excel-import', click : uploadAttachments},"-",
				{text : '下载附件', id : 'download', icon :'excel-export', click : downloadAttachments},"-",
				{text : '返回', id : 'return', icon : 'return', click : back}//,
				//"-",{text : '问题来源录入',id :'qustR',icon : 'add',click : qustR},
				//"-",{text : '查看问题来源列表',id :'qustRList',icon : 'detail',click : qustRList}
			];
		}else if(buff.indexOf("cn_bglr")!=-1 || buff.indexOf("yl_bglr")!=-1){
			bar = [
				{text : '打印信息表',id : 'printInfo',icon : 'print',click : printInfo}, "-",	       
 		        {text : '报告录入',id : 'input',icon : 'modify',click : input}, "-",
				{text : '生成编号',id : 'addNum',icon : 'modify',click : addNum},"-",
				{text : '增加编制人',id : 'addEditor',icon : 'modify',click : addEditor},"-",
				{text : '查看原始记录', id : 'showRecord', icon : 'detail', click : showRecord},"-",
				{text : '查看质量资料', id:'showQuality',icon:'detail', click: showQuality},'-', 
				{text : '查看图片', id:'showPics',icon:'detail', click: showPics},'-', 
 		        {text : '流转过程', id:'flow_note',icon:'follow', click: getFlow},"-",
				{text : '报告复制',id : 'copy',icon : 'copy',click : copy},"-",
				{text : '提交审核',id : 'copy',icon : 'search',click : validation},"-",
				{text : '提交记录',id : 'subHistory',icon : 'detail',click : subHistory},"-",
				{text : '报告作废',id : 'del',icon : 'delete',click : del},"-",
				{text : '退回', id:'backINfo',icon:'back', click: reportBackINfo},"-",
				{text : '上传附件', id:'upload',icon:'excel-import', click: uploadAttachments},"-",
				{text : '下载附件', id:'download',icon:'excel-export', click: downloadAttachments},"-",
				{text : '打印检验申请表',id : 'printApply',icon : 'print',click : printApply}, '-',
				{text : '打印资料归档目录', id:'printEnd',icon:'print', click: doPrintEnd},"-",
				{text : '返回', id:'return',icon:'return', click: back}//,
				//"-",{text : '问题来源录入',id :'qustR',icon : 'add',click : qustR},
				//"-",{text : '查看问题来源列表',id :'qustRList',icon : 'detail',click : qustRList}
			];
		}else{
			bar = [
				{text : '打印信息表',id : 'printInfo',icon : 'print',click : printInfo}, "-",	       
				{text : '报告录入',id : 'input',icon : 'modify',click : input}, "-",
				{text : '生成编号',id : 'addNum',icon : 'modify',click : addNum},"-",
				{text : '增加编制人',id : 'addEditor',icon : 'modify',click : addEditor},"-",
				{text : '查看原始记录', id : 'showRecord', icon : 'detail', click : showRecord},"-",
				{text : '查看质量资料', id:'showQuality',icon:'detail', click: showQuality},'-', 
				{text : '查看图片', id:'showPics',icon:'detail', click: showPics},'-', 
 		        {text : '流转过程', id:'flow_note',icon:'follow', click: getFlow},"-",
				{text : '报告复制',id : 'copy',icon : 'copy',click : copy},"-",
				{text : '提交审核',id : 'copy',icon : 'search',click : validation},"-",
				{text : '提交记录',id : 'subHistory',icon : 'detail',click : subHistory},"-",
				{text : '报告作废',id : 'del',icon : 'delete',click : del},"-",
				{text : '退回', id:'backINfo',icon:'back', click: reportBackINfo},"-",
				{text : '上传附件', id:'upload',icon:'excel-import', click: uploadAttachments},"-",
				{text : '下载附件', id:'download',icon:'excel-export', click: downloadAttachments},"-",
				{text : '返回', id:'return',icon:'return', click: back}//,
				//"-",{text : '问题来源录入',id :'qustR',icon : 'add',click : qustR},
				//"-",{text : '查看问题来源列表',id :'qustRList',icon : 'detail',click : qustRList}
				];
			
		}		
	}
	if(buff.indexOf("_rwfp")!=-1){
		unitcode = 	<sec:authentication property='principal.department.id' htmlEscape='false' />
		bar =[{ text:'任务分配', id:'rwfp',icon:'search', click: rwfp},"-",{ text:'流转过程', id:'flow_note',icon:'follow', click: getFlow},"-",{ text:'退回', id:'backINfo',icon:'back', click: backINfo}];
		//condition=[{name : "check_unit_id", compare : "=", value : unitcode}]
		type="02";
		top_name="任务分配";
		
	}
	if(buff.indexOf("_xmfzrsh")!=-1){
		
		bar =[{ text:'项目负责人校验', id:'check',icon:'search', click: check},"-",{ text:'流转过程', id:'flow_note',icon:'follow', click: getFlow},"-",{ text:'返回', id:'back',icon:'back', click: back}];
		type="03";
		top_name="项目负责人校验";
		 
	}
	if(buff.indexOf("_bgsh")!=-1){
		bar =[
			{ text:'批量审核', id:'batchCheck',icon:'search', click: batchCheck},"-",
			{ text:'单份审核', id:'check',icon:'search', click: check},"-",
			{ text : '查看原始记录', id : 'showRecord', click : showRecord, icon : 'detail' },"-",
			{text : '查看质量资料', id:'showQuality',icon:'detail', click: showQuality},'-', 
			{ text:'查看图片', id:'showPics',icon:'detail', click: showPics},'-', 
			{ text:'批量退回', id:'subBack',icon:'back', click: subBack},"-",
			{ text:'下载附件', id:'download',icon:'excel-export', click: downloadAttachments},"-",
			{ text:'流转过程', id:'flow_note',icon:'follow', click: getFlow},"-",
			{ text:'返回', id:'back',icon:'back', click: back}
		];
		type="04";
		top_name="报告审核";
		type_name="审核";
	}
 	
	if(buff.indexOf("_bgqf")!=-1){
		bar =[
			{ text:'批量签发', id:'batchCheck',icon:'search', click: batchCheck},"-",
			{ text:'单份签发', id:'check',icon:'search', click: check},"-",
			{ text : '查看原始记录', id : 'showRecord', click : showRecord, icon : 'detail' },"-",
			{text : '查看质量资料', id:'showQuality',icon:'detail', click: showQuality},'-', 
			{ text:'查看图片', id:'showPics',icon:'detail', click: showPics},'-', 
			{ text:'批量退回', id:'qfBack',icon:'back', click: qfBack},"-",
			{ text:'下载附件', id:'download',icon:'excel-export', click: downloadAttachments},"-",
			{ text:'流转过程', id:'flow_note',icon:'follow', click: getFlow},"-",
			"-",{ text:'返回', id:'back',icon:'back', click: back}
		];
		type="05";
		top_name="报告签发";
		type_name="签发";
	}
	

	if(buff.indexOf("_dybg")!=-1){
		bar =[{ text:'查看报告', id:'showReport',icon:'detail', click: showReport},"-",
          	{ text:'打印报告', id:'print',icon:'print', click: doPrintReport},"-",
          	//{text :'报告作废',id : 'del',icon : 'delete',click : del},
          	{ text:'下载附件', id:'download',icon:'excel-export', click: downloadAttachments},"-",
          	{ text:'流转过程', id:'flow_note',icon:'follow', click: getFlow}];
          //	{ text:'退回修改', id:'returnIput',icon:'return', click: backInput},"-",{ text:'返回', id:'back',icon:'back', click: back}];
		
	}

	if(buff.indexOf("_bglq")!=-1){
		bar =[ { text:'查看报告', id:'showReport',icon:'detail', click: showReport},"-",
		       { text:'报告领取', id:'getinput',icon:'modify', click: getReport},"-",
		       //{ text:'打印标签', id:'printTags',icon:'print', click: doPrintTags},"-",
		       { text:'二维码标签', id:'printTagsE',icon:'print', click: printTagsE},
		       //{text :'报告作废',id : 'del',icon : 'delete',click : del},
		       //{ text:'下载附件', id:'download',icon:'excel-export', click: downloadAttachments},"-",
		       { text:'流转过程', id:'flow_note',icon:'follow', click: getFlow},"-",
	           { text:'领取记录', id:'history',icon:'detail', click: history},"-",{ text:'返回', id:'back',icon:'back', click: back}];
		
	}

	if(buff.indexOf("_bggd")!=-1){
		bar =[{ text:'查看报告', id:'showReport',icon:'detail', click: showReport},"-",
		      { text:'报告归档', id:'reportEnd',icon:'info-save', click: reportEnd},"-",
		      //{ text:'下载附件', id:'download',icon:'excel-export', click: downloadAttachments},"-",
		      { text:'流转过程', id:'flow_note',icon:'follow', click: getFlow},"-",
		      { text:'返回', id:'back',icon:'back', click: back}];
		
	}

	
	
	var qmUserConfig = {

		sp_fields : [
		{
			name : "device_registration_code",
			compare : "like",
			value : ""
		},
		{name:"report_sn", id:"report_sn", compare:"like"},
		{
			name : "com_name",
			compare : "like",
			value : ""
		},
		{
			name : "make_units_name",
			compare : "like",
			value : ""
		},
		{
			name : "maintain_unit_name",
			compare : "like",
			value : ""
		},
		{
			name : "enter_op_name",
			compare : "like",
			value : ""
		},
		{
			name : "check_type",
			compare : "="
		},
		{
			name : "big_class",
			compare : "="
		}

		],
		tbar :bar,
		listeners : {
			selectionChange : function(rowData, rowIndex) {
				var count = Qm.getSelectedCount();//行选择个数
				if(buff.indexOf("dt_receive")!=-1){
					
					selectionChange();
				}else if(buff.indexOf("yl_")!=-1){
					Qm.setTbar({subBack:count>0,qfBack:count>0,printInfo:count>0,printApply:count>0,addNum:count>0,toPrint:count==1,del:count>0,getinput : count>0,flow_note : count==1,returnIput: count==1,print: count>0,printTags:count>0,showReport : count==1,history : count==1,input : count == 1,detail : count == 1,device : count == 1,rwfp : count >= 1,backINfo:count==1,batchCheck:count>1, check : count == 1,copy : count > 0,reportEnd:count>0,
						upload:count==1,download:count==1,printTagsE:count>0,qustR:count>0,qustRList:count==1,addEditor:count==1,showPics:count==1,showRecord:count==1,updateDevices:count>0,printEnd:count>0,showQuality:count==1});
				}else{
					
					Qm.setTbar({subBack:count>0,qfBack:count>0,printInfo:count>0,printApply:count==1,addNum:count>0,toPrint:count==1,del:count>0,getinput : count>0,flow_note : count==1,returnIput: count==1,print: count>0,printTags:count>0,showReport : count==1,history : count==1,input : count == 1,detail : count == 1,device : count == 1,rwfp : count >= 1,backINfo:count==1,batchCheck:count>1, check : count == 1,copy : count > 0,reportEnd:count>0,
						upload:count==1,download:count==1,printTagsE:count>0,qustR:count>0,qustRList:count==1,addEditor:count==1,showPics:count==1,showRecord:count==1,updateDevices:count>0,printEnd:count>0,showQuality:count==1});
				}
				
			},
			rowAttrRender : function(rowData, rowid) {
				var fontColor="black";
		     	// 数据状态（2：已录入报告）
				if (rowData.is_report_input == '2'){
		       		fontColor="blue";
		  		}
				if (rowData.is_validation == '1'){
		            	fontColor="gray";
		            }
		        return "style='color:"+fontColor+"'";
			}
	//,

			//afterQmReady : function() {

			//	Qm.setCondition([ {
			//		name : "handler_id",
			//		compare : "=",
			//		value : userId
			//	},{
			//		name : "flow_note_num",
			//		compare : "=",
			//		value : acc_id
			//	}
				
				
				//]);

			//	Qm.searchData();
			//}
		}
	};
	
	// 行选择改变事件
	function selectionChange() {
   		var count = Qm.getSelectedCount(); // 行选择个数
   		//alert(count);
     	if(count == 1){
            Qm.setTbar({history: true, flow_note: true, showReport: true,showQuality:true,
            	getinput: true, back:true,rwfp:true,qustR:true,qustRList:true});            	
 		}else if(count > 1){
       		Qm.setTbar({history: true, flow_note: false, showReport: false,showQuality:false,
       			getinput: true, back:true,rwfp:true,qustR:true,qustRList:false});
    	}else{
    		Qm.setTbar({history: true, flow_note: false, showReport: false,showQuality:false,
    			getinput: false, back:true,rwfp:false,qustR:false,qustRList:false});
    	}
	}

	function detail() {
	
		top.$.dialog({
			width : 800,
			height : 500,
			lock : true,
			title : "业务详情",
			content : 'url:app/flow/info_detail.jsp?status=detail&id='+ Qm.getValueByName("id"),
			data : {
				"window" : window
			}
		});
	
	}
	
	
	function back(){
		window.location.href= "${pageContext.request.scheme}://${pageContext.request.serverName}:${pageContext.request.serverPort}${pageContext.request.contextPath}/department/basic/getFlowInfo.do";
	}
	
	function subReceive(){
		
		var is_print = Qm.getValuesByName("print_time");
		
	
		
		var temp;
		
		if(is_print==""||is_print==null){
			
			$.ligerDialog.alert("所选数据报告未打印，请重新选择！");
			return;
		}
		
		if(is_print.indexOf(",")!=-1){
			
			temp = is_print.split(",");
			for(var i = 0 ; i < temp.length ; i++){
				if(temp[i]==""||temp[i]==null){
					
					$.ligerDialog.alert("所选数据报告未打印，请重新选择！");
					return;
				}
			}
			
		}else{
		
			if(is_print==""||is_print==null){
				
				$.ligerDialog.alert("所选数据报告未打印，请重新选择！");
				return;
			}
		}
		
		$.getJSON('department/basic/subReceive.do?infoId='+Qm.getValueByName("id")+'&flow_num='+flow_num+'&acc_id='+Qm.getValueByName("activity_id"),function(data){
			
			if(data.success){
				top.$.notice("提交报告领取成功！");
				submitAction();
			}
		
		});
		
		
	}
	
	
	//验证电梯报告
    function validation(){
		//先验证报告是否存在不能提交的
    	judgment();
    	var f="0";
		var fl="0";
		var flag="0";
		var flags="0";
		var big_class=Qm.getValuesByName("big_class");
    	var areaCode=<u:dict code ="area_code"/>
    	var device_area_code=Qm.getValuesByName("regional_name");
    	var device_qr_code=Qm.getValuesByName("device_qr_code");
    	var report_sn=Qm.getValuesByName("report_sn");
    	var check_type=Qm.getValuesByName("check_type");
    	var check_type_name=Qm.getValuesByName("check_type_name");
		var unitname=Qm.getValuesByName("org_name");
	    var id=Qm.getValuesByName("id");
	    var device_registration_code=Qm.getValuesByName("device_registration_code");
	    //提交审核所需参数
	    var is_input = Qm.getValuesByName("is_report_input");
		var examine_names = Qm.getValuesByName("examine_name");
		var check_flows = Qm.getValuesByName("check_flow");
		var org_ids = Qm.getValuesByName("org_id");
		var activity_id=Qm.getValuesByName("activity_id")
		
		
	    for(var j=0;j<device_area_code.length;j++){
	    	var b="0";
    	for(var i=0;i<areaCode.length;i++){//判断电梯所在区划
    		
    			if(device_area_code[j]==areaCode[i].text){
        			f="1";
        			b="1";
        		}
    		}
    	 if(b=="0"){
    		//去掉不需要验证的数据
			device_qr_code.splice(j,1);
			id.splice(j,1);
			report_sn.splice(j,1);
			big_class.splice(j,1);
			unitname.splice(j,1);
			device_area_code.splice(j,1);
			device_registration_code.splice(j,1);
			check_type_name.splice(j,1);
			//提交审核所需参数
			is_input.splice(j,1);
			examine_names.splice(j,1);
			check_flows.splice(j,1);
			org_ids.splice(j,1);
			activity_id.splice(j,1);
			j--;//删除元素之后循环减一
    	}
    	}
    	for(var j=0;j<big_class.length;j++){//判断是否为电梯
    		if(big_class[j]=="3"){
    			if(check_type[j]=="安改维监督检验"||check_type[j]=="定期检验"){
        			fl="1";
    			}else{
    				/* //去掉不需要验证的数据
        			device_qr_code.splice(j,1);
        			id.splice(j,1);
        			report_sn.splice(j,1);
        			big_class.splice(j,1);
        			unitname.splice(j,1);
        			device_area_code.splice(j,1);
        			//提交审核所需参数
        			is_input.splice(j,1);
        			examine_names.splice(j,1);
        			check_flows.splice(j,1);
        			org_ids.splice(j,1);
        			activity_id.splice(j,1);
        			j--;//删除元素之后循环减一 */
    			}
    		}else{
    			//去掉不需要验证的数据
    			device_qr_code.splice(j,1);
    			id.splice(j,1);
    			report_sn.splice(j,1);
    			big_class.splice(j,1);
    			unitname.splice(j,1);
    			device_area_code.splice(j,1);
    			device_registration_code.splice(j,1);
    			check_type_name.splice(j,1);
    			//提交审核所需参数
    			is_input.splice(j,1);
    			examine_names.splice(j,1);
    			check_flows.splice(j,1);
    			org_ids.splice(j,1);
    			activity_id.splice(j,1);
    			j--;//删除元素之后循环减一
    		}
    	}
    	for(var j=0;j<device_qr_code.length;j++){//判断是否有二维码
    		if(device_qr_code[j]!=""){
    			flags="1";
    		}else{
    			//去掉不需要验证的数据
    			device_qr_code.splice(j,1);
    			id.splice(j,1);
    			report_sn.splice(j,1);
    			big_class.splice(j,1);
    			unitname.splice(j,1);
    			device_area_code.splice(j,1);
    			device_registration_code.splice(j,1);
    			check_type_name.splice(j,1);
    			//提交审核所需参数
    			is_input.splice(j,1);
    			examine_names.splice(j,1);
    			check_flows.splice(j,1);
    			org_ids.splice(j,1);
    			activity_id.splice(j,1);
    			j--;//删除元素之后循环减一
    		}
    	}
    	
    	for(var j=0;j<unitname.length;j++){
    		if(unitname[j]!="援藏特检突击队"&&unitname[j]!="援疆特检突击队"){
    			flag="1";
    		}else{
    			//去掉不需要验证的数据
    			device_qr_code.splice(j,1);
    			id.splice(j,1);
    			report_sn.splice(j,1);
    			big_class.splice(j,1);
    			unitname.splice(j,1);
    			device_area_code.splice(j,1);
    			device_registration_code.splice(j,1);
    			check_type_name.splice(j,1);
    			//提交审核所需参数
    			is_input.splice(j,1);
    			examine_names.splice(j,1);
    			check_flows.splice(j,1);
    			org_ids.splice(j,1);
    			activity_id.splice(j,1);
    			j--;//删除元素之后循环减一
    		}
    		
    	}
    	if(flag=="0"||f=="0"||fl=="0"||flags=="0"){
    		  var qis_input = Qm.getValuesByName("is_report_input");
    			var qexamine_names = Qm.getValuesByName("examine_name");
    			var qcheck_flows = Qm.getValuesByName("check_flow");
    			var qorg_ids = Qm.getValuesByName("org_id");
    			var qactivity_id=Qm.getValuesByName("activity_id")
    			 var qid=Qm.getValuesByName("id");
    		subCheck(qis_input,qexamine_names,qcheck_flows,qorg_ids,qactivity_id,qid);//提交审核
    	}else{
    		top.$.dialog({
				width : 600, 
				height : 400, 
				lock : true, 
				title:"正在与成都市局验证金属二维码合法性，请耐心等待！",
				parent:api,
				content: "url:app/flow/report_validation_list.jsp?device_qr_code="+device_qr_code+"&report_sn="+report_sn+"&id="+id
						+"&is_input="+is_input+"&examine_names="+examine_names+"&check_flows="+check_flows+"&org_ids="+org_ids+"&activity_id="+activity_id
						+"&type=2"+"&device_registration_code="+device_registration_code,
				data : {"window" : window,"check_type":check_type,"check_type_name":check_type_name}
			});
    	
    	}
    }
	function judgment(){
		var is_input = Qm.getValuesByName("is_report_input").toString();
		var examine_names = Qm.getValuesByName("examine_name").toString();
		if(is_input == "" || is_input == null){
			$.ligerDialog.alert("所选数据报告未录入，请重新选择！");
			return;
		}
		if(is_input.indexOf(",")!= -1){
			var temp = is_input.split(",");
			var names = examine_names.split(",");
			for(var i = 0 ; i < temp.length ; i++){
				if(temp[i] != "2"){
					if(temp[i] == "1" && names[i]==""){
						$.ligerDialog.alert("所选数据报告未录入，请重新选择！");
						return;
					}
				}
			}
		}else{
			if(is_input != "2"){
				if(is_input == "1" && examine_names==""){
					$.ligerDialog.alert("所选数据报告未录入，请重新选择！");
					return;
				}
			}
		}
		
		var ids = Qm.getValuesByName("id");
		var check_flows = Qm.getValuesByName("check_flow");
		var check_flow1 = check_flows[0];
		for (var i = 1; i < check_flows.length; i++) {
			if(check_flows[i]!=check_flow1){
				$.ligerDialog.error('提示：请选择相同审批级别的报告！');
				return;
			}
		}
		
		// 获取检验部门
		var org_ids = Qm.getValuesByName("org_id").toString();
		org_ids = org_ids.split(",");
		var first_org_id = org_ids[0];
		for(var i=1;i<org_ids.length;i++){
			if(org_ids[i] != first_org_id){
				$.ligerDialog.error("亲，您所选的报告中存在不同检验部门的报告哦，请重新选择！");
				return;
			}
		}
	}
	function subCheck(is_inputs,examine_namess,check_flows,org_idss,activity_id,id,nid,nactivity_id){
		//var is_input = Qm.getValuesByName("is_report_input").toString();
		//var examine_names = Qm.getValuesByName("examine_name").toString();
		/* var is_input=is_inputs.toString();
		var examine_names=examine_namess.toString();
		if(is_input == "" || is_input == null){
			$.ligerDialog.alert("所选数据报告未录入，请重新选择！");
			return;
		}
		if(is_input.indexOf(",")!= -1){
			var temp = is_input.split(",");
			var names = examine_names.split(",");
			for(var i = 0 ; i < temp.length ; i++){
				if(temp[i] != "2"){
					if(temp[i] == "1" && names[i]==""){
						$.ligerDialog.alert("所选数据报告未录入，请重新选择！");
						return;
					}
				}
			}
		}else{
			if(is_input != "2"){
				if(is_input == "1" && examine_names==""){
					$.ligerDialog.alert("所选数据报告未录入，请重新选择！");
					return;
				}
			}
		}
		
		var ids = Qm.getValuesByName("id");
		var check_flows = Qm.getValuesByName("check_flow");
		var check_flow1 = check_flows[0];
		for (var i = 1; i < check_flows.length; i++) {
			if(check_flows[i]!=check_flow1){
				$.ligerDialog.error('提示：请选择相同审批级别的报告！');
				return;
			}
		}
		
		// 获取检验部门
		//var org_ids = Qm.getValuesByName("org_id").toString();
		var org_ids=org_idss.toString();
		org_ids = org_ids.split(",");
		var first_org_id = org_ids[0];
		for(var i=1;i<org_ids.length;i++){
			if(org_ids[i] != first_org_id){
				$.ligerDialog.error("亲，您所选的报告中存在不同检验部门的报告哦，请重新选择！");
				return;
			}
		} */
		
		/*
		$.get("reportItemValueAction/checkIfHg.do?ids="+ids,function(res){
			if(res.success){
				if(!res.sfhg){
					var sort_codes = Qm.getValuesByName("device_sort_code");
					var sort_code1 = sort_codes[0];
					for (var i = 1; i < sort_codes.length; i++) {
						if(sort_codes[i]!=sort_code1){
							$.ligerDialog.error('提示：请选择相同设备类型的检验信息！');
							return;
						}
					}
					
					var check_types = Qm.getValuesByName("check_type");
					var check_type1 = check_types[0];
					for (var i = 1; i < check_types.length; i++) {
						if(check_types[i]!=check_type1){
							$.ligerDialog.error('提示：请选择相同检验类型的检验信息！');
							return;
						}
					}

					var ids = Qm.getValuesByName("id");
					   top.$.dialog({
							width : 800, 
							height : 600, 
							lock : true, 
							title: "问题来源填写",
							content: 'url:app/flow/report/report_error_resource.jsp?type=sub&ids='+ids
							+"&check_type="+check_type1,
							data : {"window" : window,"device_sort_code":sort_code1}
						});
				}else{*/
				var check_flows = Qm.getValuesByName("check_flow");
				var check_flow1 = check_flows[0];
				var org_ids = Qm.getValuesByName("org_id").toString();
				var org_ids=org_idss.toString();
				org_ids = org_ids.split(",");
				var first_org_id = org_ids[0];
					top.$.dialog({
						width : 600, 
						height : 400, 
						lock : true, 
						title:"报告审核提交",
						parent:api,
						content: 'url:app/flow/audit_submit.jsp?infoId='+id+'&flow_num='+flow_num+'&check_flow='+check_flow1+'&acc_id='+activity_id+'&org_id='+first_org_id+"&nid="+nid+"&nactivity_id="+nactivity_id,
						data : {"window" : window}
					});
				/*}
			}
		})
		
		
		*/
		
	}
	
	function subCheck2(){
		var is_input = Qm.getValuesByName("is_report_input").toString();
		var examine_names = Qm.getValuesByName("examine_name").toString();
		if(is_input == "" || is_input == null){
			$.ligerDialog.alert("所选数据报告未录入，请重新选择！");
			return;
		}
		if(is_input.indexOf(",")!= -1){
			var temp = is_input.split(",");
			var names = examine_names.split(",");
			for(var i = 0 ; i < temp.length ; i++){
				if(temp[i] != "2"){
					if(temp[i] == "1" && names[i]==""){
						$.ligerDialog.alert("所选数据报告未录入，请重新选择！");
						return;
					}
				}
			}
		}else{
			if(is_input != "2"){
				if(is_input == "1" && examine_names==""){
					$.ligerDialog.alert("所选数据报告未录入，请重新选择！");
					return;
				}
			}
		}
		
		top.$.dialog({
			width : 600, 
			height : 400, 
			lock : true, 
			title:"报告审核提交",
			parent:api,
			content: 'url:app/flow/audit_submit.jsp?infoId='+Qm.getValuesByName("id")+'&flow_num='+flow_num+'&acc_id='+Qm.getValuesByName("activity_id"),
			data : {"window" : window}
		});
		
		
	}
	
	// 发微信和短信
	function sendMsgs(ids) {
		$.ajax({
			url : "department/basic/sendMsgs.do?ids=" + ids,
			type : "post",
			async : false,
			success : function(resp) {
				if (resp.success) {
					//top.$.notice("保存成功！");
					Qm.refreshGrid();
				} else {
					$.ligerDialog.alert(resp.msg);
					Qm.refreshGrid();
				}
			}
		});
	}
	
	function subBack(){
		top.$.dialog({
			width : 600, 
			height : 200, 
			lock : true, 
			title:"报告审核时退回",
			parent:api,
			content: 'url:app/flow/batch_back.jsp?type='+type+'&infoId='+Qm.getValuesByName("id")+'&flow_num='+flow_num+'&acc_id='+Qm.getValuesByName("activity_id"),
			data : {"window" : window}
		});
		
		
	}
	
	function qfBack(){
		top.$.dialog({
			width : 600, 
			height : 200, 
			lock : true, 
			title:"报告签发时退回",
			parent:api,
			content: 'url:app/flow/qf_back.jsp?type='+type+'&infoId='+Qm.getValuesByName("id")+'&flow_num='+flow_num+'&acc_id='+Qm.getValuesByName("activity_id"),
			data : {"window" : window}
		});
		
		
	}
	
	function subHistory(){
		
		top.$.dialog({
			width : 800,
			height : 600,
			lock : true,
			title : "提交记录",
			content : 'url:app/flow/subHistory_list.jsp',
			data : {
				"window" : window
			}
		});
		
		
		
	}
	
	function printInfo(){
		
	var is_input = Qm.getValuesByName("is_report_input").toString();
		
	
		
		var temp;
		
		if(is_input==""||is_input==null){
			
			// $.ligerDialog.alert("所选数据报告未录入，请重新选择！");
			// return;
		}
		
		if(is_input.indexOf(",")!=-1){
			
			temp = is_input.split(",");
			for(var i = 0 ; i < temp.length ; i++){
				if(temp[i]!="2"){
					
					// $.ligerDialog.alert("所选数据报告未录入，请重新选择！");
					// return;
				}
			}
			
		}else{
		
			if(is_input!="2"){
				
				// $.ligerDialog.alert("所选数据报告未录入，请重新选择！");
				// return;
			}
		}
	
		var report_types = Qm.getValuesByName("report_type").toString();
		
		var report_type = "";
		var check_types = Qm.getValuesByName("check_type").toString();
		var big_classs = Qm.getValuesByName("big_class").toString();
		//alert(big_classs);
		if(big_classs.indexOf("3")!=-1){
			if(check_types.indexOf("定期检验")!=-1){
				alert("亲，电梯定期检验版本还未确定，待确定后将及时更新该功能哟！");
				return;
			}
		}
	
		if(report_types.indexOf(",")!=-1){
			
			report_type = report_types.split(",");
			for(var i = 0 ; i < report_type.length ; i++){
				for(var j = 1 ; j < report_type.length ; j++){
					if(report_type[i]!=report_type[j]){
						$.ligerDialog.alert("只能选择同一个模板的报告");
						return;
					}
				}
			}
			report_types = report_type[0];
		} 
		
	
		
		$.getJSON('report/query/queryModle.do?report_type='+report_types,function(data){
			if(data.success){
				var ids = Qm.getValuesByName("id").toString();
				var w=window.screen.availWidth;
				var h=(window.screen.availHeight);			
				top.$.dialog({
					width : w, 
					height :h, 
					lock : true, 
					title:"打印信息表",
					content: 'url:app/query/report_print_index_message.jsp?report_type='+report_types+'&ids='+ids,
					data : {"window" : window}
				}).max();
			}else{
				$.ligerDialog.alert("没有找到信息表模板！");
			}
		});
		
		
		
		
		
		
	}
	
	// 打印检验申请单
	function printApply(){
		var selectedIds = Qm.getValuesByName("id").toString();  // 业务信息ID
		var device_id = Qm.getValuesByName("fk_tsjc_device_document_id").toString();  // 设备ID
		var report_sn = Qm.getValuesByName("report_sn").toString();  // 报告编号
		var check_type = Qm.getValuesByName("check_type").toString();  //检验类别
		
		var big_class = Qm.getValueByName("big_class").toString();	
		var comArr = Qm.getValuesByName("com_name");	// 使用单位	
		var first_com = comArr[0];
		
		var selectedIdsArr = selectedIds.split(",");
		var device_idArr = device_id.split(",");
		var report_snArr = report_sn.split(",");
		var check_typeArr = check_type.split(",");
		
		var diff_com = false;
		for(var i=0;i<selectedIdsArr.length;i++){
			if(selectedIdsArr[i] =="" || selectedIdsArr[i] == "null"){
				diff_com = true;
				$.ligerDialog.error("所选报告"+report_snArr[i]+"将获取不到报告信息，请重新选择或联系管理员！");
				return;
			}
		}
		for(var i=0;i<device_idArr.length;i++){
			if(device_idArr[i] == "" || device_idArr[i] == "null"){
				diff_com = true;
				$.ligerDialog.error("所选报告"+report_snArr[i]+"将获取不到设备信息，请重新选择或联系管理员！");
				return;
			}
		}
		for(var i=0;i<check_typeArr.length;i++){
			if(check_typeArr[i] == "" || check_typeArr[i] == "null"){
				diff_com = true;
				$.ligerDialog.error("所选报告"+report_snArr[i]+"检验类别为空，请重新选择或联系管理员！");
				return;
			}
		}
		for(var i=1;i<comArr.length;i++){
			if(comArr[i] != first_com){
				diff_com = true;
				$.ligerDialog.error("只能打印使用单位一致的报告，请重新选择！");
				return;
			}
		}
		
		if(!diff_com){
			$.getJSON("department/basic/getDeviceDetail.do?status=detail&id="+selectedIds+"&device_id="+device_id, function(resp){
				if(resp.success){
						if(resp.data != null && resp.data.length !=0){
							top.$.dialog({
								width : $(top).width(),
								height :  $(top).height()-40,
								lock : true,
								title : "打印检验申请单",
								parent: api,
								content : 'url:app/inspection/docEditor.jsp?status=modify',	
								data: {pwindow: window, bean: resp.data, device_type: big_class, check_type: check_type}
							}).max();
						}else{
							$.ligerDialog.alert("设备信息异常，请先检查设备信息是否完善！");
						}
				}
			})
		}
	}
	
	// 打印检验资料归档目录
	function doPrintEnd(){	
		var report_sn = Qm.getValuesByName("report_sn").toString();	//报告编号	
		var big_class = Qm.getValueByName("big_class").toString();	//设备大类
		var check_type = Qm.getValueByName("check_type").toString();  //检验类别
		var check_op_name = Qm.getValueByName("check_op_name").toString();  //检验人员
		var advance_time = Qm.getValueByName("advance_time").toString();  //检验时间
		var comArr = Qm.getValuesByName("com_name");	// 使用单位	
		var first_com = comArr[0];
		var diff_com = false;
		for(var i=1;i<comArr.length;i++){
			if(comArr[i] != first_com){
				diff_com = true;
				$.ligerDialog.error("只能打印使用单位一致的报告，请重新选择！");
				return;
			}
		}
		
		if(!diff_com){
			top.$.dialog({
				width : $(top).width(),
				height :  $(top).height()-40,
				lock : true,
				title : "打印检验资料归档目录",
				parent: api,
				content : 'url:app/query/docEditor.jsp?status=modify',	
				data: {pwindow: window, report_sn: report_sn, device_type: big_class, check_type: check_type, report_com_name: first_com, check_op_name: check_op_name, advance_time:advance_time}
			}).max();
		}
	}
	
	function addNum(){
		var report_sn_list = Qm.getValuesByName("report_sn").toString();
		var report_snArr = report_sn_list.split(",");
		for(var i=0;i<report_snArr.length;i++){
			if(report_snArr[i]!=""){
				$.ligerDialog.error("所选报告已生成了报告书编号，请重新选择！");
				return;
			}
		}
		$.ligerDialog.confirm('确定生成报告书编号?', function (yes) { 
			if(yes){
				$.getJSON('department/basic/flow_addNum.do?infoId='+Qm.getValuesByName("id"),function(data){
					if(data){
						top.$.notice("编号生成成功！");
						submitAction();
					}else{
						$.ligerDialog.alert(data.msg,"提示");
					}
				});
			}
		});
	}
	
	function reportEnd(){
		
		
		$.ligerDialog.confirm('确定归档该数据?', function (yes) { 
	
			if(yes){
				
				$.getJSON('department/basic/flow_reportEnd.do',{infoId:Qm.getValuesByName("id"),flow_num:flow_num ,process_id:Qm.getValuesByName("process_id")},function(data){
					
					if(data){
						top.$.notice("归档成功！");
						submitAction();
					}
				
				});
				
				
			}
		
		
	});
	
		
	}
	
	function toPrint(){
		
	var is_input = Qm.getValuesByName("is_report_input").toString();
	
	
	
	var temp;
	
	if(is_input==""||is_input==null){
		
		// $.ligerDialog.alert("所选数据报告未录入，请重新选择！");
		// return;
	}
	
	if(is_input.indexOf(",")!=-1){
		
		temp = is_input.split(",");
		for(var i = 0 ; i < temp.length ; i++){
			if(temp[i]!="2"){
				
				// $.ligerDialog.alert("所选数据报告未录入，请重新选择！");
				// return;
			}
		}
		
	}else{
	
		if(is_input!="2"){
			
			// $.ligerDialog.alert("所选数据报告未录入，请重新选择！");
			// return;
		}
	}
		
	
	
		$.ligerDialog.confirm('确定提交该数据?', function (yes) { 
	
			if(yes){
				
				$.getJSON('department/basic/flow_toPrint.do',{infoId:Qm.getValueByName("id"),flow_num: flow_num,acc_id:Qm.getValueByName("activity_id")},function(data){
					
					if(data){
						top.$.notice("提交成功！");
						submitAction();
					}
				
				});
				
				
			}
		
		
	});
	
		
	}
	
	// 单份审核或签发报告
	function check(){
		var device_type = Qm.getValueByName("device_sort_code").toString().substring(0, 1);
		var device_sort_code = Qm.getValueByName("device_sort_code").toString();
		// 获取报告审批流程（0：两级审核 1：一级审核）
		var check_flow = Qm.getValueByName("check_flow").toString();
		// 获取报告检验部门
		var org_id = Qm.getValueByName("org_id").toString();
		top.$.dialog({
			width : 800, 
			height : 500, 
			lock : true, 
			title: top_name,
			content: 'url:department/basic/reportInfoLoad.do?type='+type+'&device_type='+device_type+'&device_sort_code='+device_sort_code+'&check_flow='+check_flow+'&flow_num='+flow_num+'&acc_id='+Qm.getValuesByName("activity_id")+'&report_type='+ Qm.getValuesByName("report_type")+'&ins_info_id='+Qm.getValuesByName("id")+'&device_id='+Qm.getValueByName("fk_tsjc_device_document_id")+'&org_id='+org_id,
			data : {"window" : window}
		}).max();
	}
	
	// 批量审核或批量签发报告
	function batchCheck(){	
		var ids = Qm.getValuesByName("id").toString();
		var count = ids.split(",");
		if(count.length>50){
			$.ligerDialog.alert("请勿一次批量操作大于50份报告！");
			return;
		}
		var device_type = Qm.getValueByName("device_sort_code").toString().substring(0, 1);
		var device_sort_code = Qm.getValueByName("device_sort_code").toString();
		// 获取报告审批流程（0：两级审核 1：一级审核）
		var check_flows = Qm.getValuesByName("check_flow").toString();
		check_flows = check_flows.split(",");
		var first_check_flow = check_flows[0];
		for(var i=1;i<check_flows.length;i++){
			if(check_flows[i] != first_check_flow){
				$.ligerDialog.error("亲，您所选的报告中存在审核流程不一致的报告哦，请重新选择！");
				return;
			}
		}
		// 获取检验部门
		var org_ids = Qm.getValuesByName("org_id").toString();
		org_ids = org_ids.split(",");
		var first_org_id = org_ids[0];
		for(var i=1;i<org_ids.length;i++){
			if(org_ids[i] != first_org_id){
				$.ligerDialog.error("亲，您所选的报告中存在不同检验部门的报告哦，请重新选择！");
				return;
			}
		}
		var w=window.screen.availWidth;
		var h=(window.screen.availHeight);	
		top.$.dialog({
			width : w, 
			height :h, 
			lock : true, 
			title:"批量"+type_name,
			content: 'url:app/flow/report/report_batch_index.jsp?ids='+ids+'&type='+type+'&device_type='+device_type+'&device_sort_code='+device_sort_code+'&check_flow='+first_check_flow+'&acc_id='+Qm.getValuesByName("activity_id").toString()+'&flow_num='+flow_num+'&org_id='+first_org_id,
			data : {"window" : window}
		}).max();
	}
	
	function backInput(){
		
		
		$.ligerDialog.confirm('确定回退修改?', function (yes) { 
	
			if(yes){
				
				$.getJSON('department/basic/flow_returnInput.do',{infoId:Qm.getValueByName("id"),flow_num: Qm.getValueByName("flow_num"),acc_id:Qm.getValueByName("activity_id")},function(data){
					
					if(data){
						top.$.notice("退回成功！");
						submitAction();
					}
				
				});
				
				
			}
		
		
	});
		
		
	}
	
	function device() {
		
	
		//查询设备ID和设备种类
		$.getJSON('department/basic/getDeviceType.do',{infoId:Qm.getValueByName("id")},function(data){
			
			if(data.success){
				
				top.$.dialog({
					width : 1000,
					height : 600,
					lock : true,
					title : "设备信息",
					content : 'url:app/device/device_detail.jsp?status=detail&id='+data.device_id+'&device_type='+data.device_type,
					data : {
						"window" : window
					}
				});
				
			}
		});
		
	
	}
	function copy() {
	
		
		//获取报告类型id
		var report_types = Qm.getValuesByName("report_type").toString();
		
		var report_type = "";
		
	
		if(report_types.indexOf(",")!=-1){
			
			report_type = report_types.split(",");
			for(var i = 0 ; i < report_type.length ; i++){
				for(var j = 1 ; j < report_type.length ; j++){
					if(report_type[i]!=report_type[j]){
						$.ligerDialog.alert("只能选择同一个模板的报告");
						return;
					}
				}
			}
			report_types = report_type[0];
		} 
		
		//判断所选ID是否多个
		var ids = Qm.getValuesByName("id").toString();
		
		var par =null;
	
		var cArr=[];
		
		
		
		
		if(ids.indexOf(",")!=-1){
			
			var	temp = ids.split(",");
			
			for(var i in temp){
				
				cArr[cArr.length]="'"+temp[i]+"'";
				
			}
			
			par = cArr.join(",");
		}else{
			par="'"+ids+"'";
		}
		
		var report_name = Qm.getValueByName("report_name").toString();
	
		top.$.dialog({
	
	
	
			width :800, 
			height : 600, 
			lock : true, 
			title:"报告复制",
			content: 'url:app/flow/report_copy_list.jsp?ids='+ids+'&par='+par+'&report_type='+report_types+'&report_name='+encodeURIComponent(report_name),
					
			
			data : {"window" : window}
	
		});
		
	}
	
	function saveReport(infoId,reportId,deviceId) {
		
	
		
		 top.$.dialog({
				width : 800, 
				height : 500, 
				lock : true, 
				title:"报告信息",
				content: 'url:department/basic/reportInfoLoad.do?isSub=yes&type=input'
						+'&report_type='+reportId+'&ins_info_id='+infoId+'&device_id='+deviceId,
				data : {"window" : window}
			}).max();
	
	}
	
	
	function input() {
		/*
		var big_class = Qm.getValueByName("big_class").toString();
		var check_type = Qm.getValueByName("check_type").toString();
		var is_mobile = Qm.getValueByName("is_mobile").toString();
		if("3" == big_class && "3" == check_type  && "1" == is_mobile){
			$.ligerDialog.alert("电梯定检报告无法使用该功能，修改报告请先修改原始记录！");
			return;
		}else{*/
			top.$.dialog({
				width : 800,
				height : 600,
				lock : true,
				title : "报告项目",
				content : 'url:department/basic/flow_reportInput.do?type=input&flow_num='+flow_num+'&id='
						+ Qm.getValueByName("id")+'&org_id='+Qm.getValueByName("org_id")+ '&report_type='
						+ Qm.getValueByName("report_type") +'&activity_id='+Qm.getValuesByName("activity_id")
						+'&device_id='+Qm.getValueByName("fk_tsjc_device_document_id"),
	
				data : {
					"window" : window
				}
			});
		//}		
	}
	
	function rwfp(){
		
		top.$.dialog({
			width : 900, 
			height : 600, 
			lock : true, 
			title: top_name,
			content: 'url:app/inspection/servicePlan_detail.jsp?status=modify&type='+type+'&org_id='+unitcode+'&id='+Qm.getValuesByName("id")+'&ywid='+Qm.getValuesByName("ywid")+'&acc_id='+Qm.getValuesByName("activity_id")+'&flow_num='+flow_num,
			data : {"window" : window}
		});
	}
	//报告领取
	function getReport() {
		var report_com_name = Qm.getValueByName("com_name");	// 报告书使用单位
			var area_name = Qm.getValueByName("regional_name");	// 安装区域
			//var comArr = Qm.getValuesByName("com_name");	// 报检单位
			var fee_statusArr = Qm.getValuesByName("fee_status");
			for(var i=0;i<fee_statusArr.length;i++){
				if("待收费" == fee_statusArr[i]){
					$.ligerDialog.alert("待收费的报告，不能领取！");
					return;
				}
			}
			top.$.dialog({
				width : 700, 
				height : 300, 
				lock : true, 
				title : "报告领取", 
				data : {"window" : window},
				content : 'url:app/flow/report_draw_detail.jsp?status=add&id=' + Qm.getValuesByName("id")+'&acc_id='+Qm.getValuesByName("activity_id")+'&flow_num='+flow_num+'&report_com_name='+encodeURIComponent(report_com_name)+'&area_name='+encodeURIComponent(area_name)
			});
	}
	
	//报告领取记录
	function history() {
		top.$.dialog({
			width : 700, 
			height : 500, 
			lock : true, 
			title : "报告领取记录", 
			data : {"window" : window},
			content : 'url:app/flow/report_draw_history.jsp'
		});
	}
	// 查看报告
	function showReport(){	
		var id = Qm.getValueByName("id").toString();
		var report_id = Qm.getValueByName("report_type").toString();	// 报告类型
		//var is_user_defined = Qm.getValueByName("is_user_defined").toString();	// 自定义报告
		//if(is_user_defined==""){
			var w=window.screen.availWidth;
			var h=(window.screen.availHeight);
			var url = "report/query/showReport.do?id="+id+"&report_id="+report_id;
			top.$.dialog({
				width : w, 
				height : h, 
				lock : true, 
				title:"报告信息",
				content: 'url:'+url,
				data : {"window" : window}
			}).max();
			//var fileValue = window.showModalDialog(url,[],"dialogwidth:"+w+";dialogheight:"+h+";help=no;status=no;center=yes;edge=sunken;resizable=yes");
	
	}
	
	// 打印报告
	function doPrintReport(){	
		var ids = Qm.getValuesByName("id").toString();
		//alert(Qm.getValuesByName("big_class").toString());
		//var report_id = Qm.getValueByName("report_type").toString();	// 报告类型
		//var is_user_defined = Qm.getValueByName("is_user_defined").toString();	// 自定义报告
		//if(is_user_defined==""){
			var w=window.screen.availWidth;
			var h=(window.screen.availHeight);			
			top.$.dialog({
				width : w, 
				height :h, 
				lock : true, 
				title:"打印报告",
				content: 'url:app/query/report_print_index.jsp',
				data : {
					"window" : window,
					"id":ids,
					"acc_id":Qm.getValuesByName("activity_id").toString(),
					"flow_num":flow_num
				}
			}).max();
			//url = "/cfdinfo?CONTROLLER=com.khnt.command.BlankSecuredCmd&NEXT_PAGE=TSJY_REPORT_PRINT_INDEX&id="+ids;
			//window.showModalDialog(url,[],"dialogwidth:"+w+";dialogheight:"+h+";help=no;status=no;center=yes;edge=sunken;resizable=yes");
		//} else {
		//	$.ligerDialog.alert("自定义报告请通过“查看报告”按钮下载报告文档进行打印");
		//}
	}
	
	// 打印标签
	function doPrintTags(){	
		var device_id = Qm.getValuesByName("fk_tsjc_device_document_id").toString();
		var conclusions = Qm.getValuesByName("inspection_conclusion").toString();
		if(conclusions.indexOf("不合格")!=-1){
			$.ligerDialog.error("所选报告中包含有检验不合格的报告，不能打印标签，请重新选择！");
			return;
		}
		var ids = Qm.getValuesByName("id").toString();
		var w=window.screen.availWidth;
		var h=(window.screen.availHeight);			
		top.$.dialog({
			width : w, 
			height :h, 
			lock : true, 
			title:"打印标签",
			content: 'url:app/query/report_print_index_tags.jsp?id='+ids+'&device_id='+device_id,
			data : {"window" : window}
		}).max();
	}
	
	// 打印二维码标签
	function printTagsE(){	
		var device_id = Qm.getValuesByName("fk_tsjc_device_document_id").toString();
		var conclusions = Qm.getValuesByName("inspection_conclusion").toString();
		if(conclusions.indexOf("不合格")!=-1){
			$.ligerDialog.error("所选报告中包含有检验不合格的报告，不能打印标签，请重新选择！");
			return;
		}
		var ids = Qm.getValuesByName("id").toString();
		var w=window.screen.availWidth;
		var h=(window.screen.availHeight);			
		top.$.dialog({ 
			width : w, 
			height :h, 
			lock : true, 
			title:"打印标签",
			content: 'url:app/query/report_print_index_tags.jsp?flag=yes&id='+ids+'&device_id='+device_id,
			data : {"window" : window}
		}).max();
	}
	
	//流转过程
	function  getFlow(){
		
		 top.$.dialog({
	   			width : 400, 
	   			height : 700, 
	   			lock : true, 
	   			title: "流程卡",
	   			content: 'url:department/basic/getFlowStep.do?ins_info_id='+Qm.getValuesByName("id"),
	   			data : {"window" : window}
	   		});
	
		
	}
	//任务分配退回
	function backINfo(){
		var selectedId = Qm.getValuesByName("id");
		if (selectedId.length < 1) {
			$.ligerDialog.alert('请先选择要退回的事项！', "提示");
			return;
		}
		
		 
		 $.ligerDialog.confirm('确定回退到科室报检?', function (yes) { 
	
				if(yes){
					
					$.getJSON('department/basic/backINfo.do?infoId='+Qm.getValuesByName("ywid")+'&flow_num='+flow_num+'&acc_id='+Qm.getValuesByName("activity_id"),function(data){
						
						if(data){
							top.$.notice("退回成功！");
							submitAction();
						}
					
					});
				}
		});
	}	
	//任务分配退回
	function reportBackINfo(){
		var selectedId = Qm.getValuesByName("id");
		if (selectedId.length < 1) {
			$.ligerDialog.alert('请先选择要退回的报告！', "提示");
			return;
		}
		//top.$.dialog({
		//	width : 270,
		//	height : 150,
		//	lock : true,
		//	id:"chooseWindow",
		//	title : "退回选择",
		//	max:false,
	    //    min:false,
		//	content : "url:app/flow/reportBackNext.jsp?infoId="+Qm.getValuesByName("ywid")+"&flow_num="+flow_num+"&acc_id="+Qm.getValuesByName("activity_id"),
		//	data:{"pwindow":window}
	    //});
		
		// $.ligerDialog.confirm('确定回退到科室报检?', function (yes) { 
			//	if(yes){
					//$.getJSON('department/basic/backINfo.do',{infoId:Qm.getValueByName("ywid"),flow_num:flow_num,acc_id:Qm.getValueByName("activity_id")},function(data){
					//	if(data){
						//	top.$.notice("退回成功！");
							//submitAction();
						//}
					
					//});
				//}
		//});
		
		var is_mobile = Qm.getValuesByName("is_mobile").toString();
		if(is_mobile.indexOf("1") != -1){
			$.ligerDialog.alert('亲，您所选的报告由移动设备出具的原始记录生成，无法执行该操作！', "提示");
			return;
		}else{
			var ywid = Qm.getValuesByName("ywid").toString();
			var activity_id = Qm.getValuesByName("activity_id").toString();
			$.ligerDialog.confirm('确定要退回到业务报检？', function (yes) { 
				if(yes){
					$.getJSON('department/basic/reportBackINfo.do',{nextHandle:'2',infoId:ywid,flow_num:flow_num,acc_id:activity_id},function(data){
						if(data){
							top.$.notice("退回成功！");
							submitAction();
						}
									
					});
				}
			});
		}
	}


	function del(){
		var is_mobile = Qm.getValuesByName("is_mobile").toString();
		if(is_mobile.indexOf("1") != -1){
			$.del("亲，您所选的报告由移动设备出具的原始记录生成，作废报告原始记录也将作废，确定作废？作废后，可用移动设备重新提交。",
		    		"department/basic/delReport.do",
		    		{"ids":Qm.getValuesByName("id").toString()});
		}else{
			$.del("确定作废？",
		    		"department/basic/delReport.do",
		    		{"ids":Qm.getValuesByName("id").toString()});
		}
	}

	function addEditor(){
		var is_mdy_editor = Qm.getValueByName("is_mdy_editor").toString();
		if(is_mdy_editor != "1"){
			$.ligerDialog.alert('亲，您所选的报告类型系统暂不支持增加编制人哦！', "提示");
			return;
		}
		top.$.dialog({
			width : 600, 
			height : 400, 
			lock : true, 
			title : "增加编制人", 
			data : {"window" : window},
			content : 'url:app/inspection/mdy_editor.jsp?status=modify&info_id=' + Qm.getValueByName("id").toString() + '&org_id=' + Qm.getValueByName("org_id").toString()
		});
	}
	
	function uploadAttachments(){
		var is_upload = Qm.getValueByName("is_upload").toString();
		var sort_code = getDeviceClassifyCode(Qm.getValueByName("sort_code").toString(),deviceClassify);
		//1`制造监督检验`2`安改维监督检验`3`定期检验`4`委托检验`5`其他检验
		//`6`起重首检`7`进口设备检验`8`出口设备检验`9`资料审查`
		var check_type = Qm.getValueByName("check_type").toString();
		if((/^3[0-9]{3}$/.test(sort_code)&&check_type.indexOf("监督")!=-1)||is_upload == "1"){
			top.$.dialog({
				width : 600, 
				height : 400, 
				lock : true, 
				title : "上传附件", 
				data : {"window" : window},
				content : 'url:app/flow/report_attachment_upload.jsp?status=modify&info_id=' + Qm.getValueByName("id").toString()
			});
		}else{
			$.ligerDialog.alert('亲，系统暂不支持该类报告的附件上传功能哦！', "提示");
			return;
		}
		
	}
	
	// 查看报告
	function showReport(){	
		var id = Qm.getValueByName("id").toString();
		var ispdf =  Qm.getValuesByName("export_pdf").toString();
		if(ispdf==null||ispdf==""){
			var report_id = Qm.getValueByName("report_type").toString();	// 报告类型
			var url = "report/query/showReport.do?id="+id+"&report_id="+report_id;
			top.$.dialog({
				width : w, 
				height : h, 
				lock : true, 
				title:"查看报告",
				content: 'url:'+url,
				data : {"window" : window}
			}).max();
		}else{
			var report_sn = Qm.getValueByName("report_sn").toString();
			top.$.dialog({
				width : 800, 
				height : 400, 
				lock : true, 
				title:"查看报告",
				content: 'url:app/flow/reportPdfPrint/report_doc.jsp?status=detail&id='+id,
				data : {"window" : window,"report_sn":report_sn,"date":ispdf}
			}).max();
		}				
	}
	
	// 查看原始记录
	function showRecord() {
		var id = Qm.getValueByName("id").toString();
		var report_id = Qm.getValueByName("report_type").toString();	// 报告类型
		var is_mobile = Qm.getValueByName("is_mobile").toString();		// 是否移动设备出具（0：否 1：是）
		if("1" == is_mobile){
			var url = "report/item/record/showRecord.do?id="+id+"&report_id="+report_id;
			top.$.dialog({
				width : w, 
				height : h, 
				lock : true, 
				title:"查看原始记录",
				content: 'url:'+url,
				data : {"window" : window}
			}).max();
		}else{
			$.ligerDialog.alert('亲，该报告非移动设备出具，无法查看原始记录哦！', "提示");
			return;
		}
	}
	
	// 预览并下载图片
	function showPics() {
		var is_mobile = Qm.getValueByName("is_mobile").toString();		// 是否移动设备出具（0：否 1：是）
		if("1" == is_mobile){
			top.$.dialog({
				width : 800, 
				height : 500, 
				lock : true, 
				title : "查看图片", 
				data : {"window" : window},
				cancel : true,
				content : 'url:app/mobile/record_pic_list.jsp?info_id=' + Qm.getValueByName("id").toString()
			});
		}else{
			$.ligerDialog.alert('亲，该报告非移动设备出具，无法查看现场检验图片哦！', "提示");
			return;
		}	
	}

	// 下载附件
	function downloadAttachments() {
		var is_upload = Qm.getValueByName("is_upload").toString();
		var sort_code = getDeviceClassifyCode(Qm.getValueByName("sort_code").toString(),deviceClassify);
		var check_type = Qm.getValueByName("check_type").toString();
		if((/^3[0-9]{3}$/.test(sort_code)&&check_type.indexOf("监督")!=-1)||is_upload == "1"){
			top.$.dialog({
				width : 600, 
				height : 400, 
				lock : true, 
				title : "下载附件", 
				data : {"window" : window},
				cancel : true,
				content : 'url:app/flow/report_attachment_upload.jsp?status=detail&info_id=' + Qm.getValueByName("id").toString()
			});
		}else{
			$.ligerDialog.alert('亲，系统暂不支持该类报告的附件下载功能哦！', "提示");
			return;
		}
	}
	
	function updateDevices(){
		var device_type = Qm.getValueByName("big_class").substring(0, 1);
		if("3" != device_type && "4" != device_type && "5" != device_type && "6" != device_type){
			alert("目前仅支持同步电梯、起重、游乐、场（厂）车信息！");
			return;
		}else{
			top.$.dialog({
				width : 520,
				height : 280,
				lock : true,
				title : "同步设备信息",
				content : 'url:app/device/device_update.jsp?status=modify&ids='
						+ Qm.getValuesByName("ywid"),
				data : {
					"window" : window
				}
			});
		}
	}

	// 单份审核或签发报告
	function qustR(){
		var ids = Qm.getValuesByName("id");
		

		var sort_codes = Qm.getValuesByName("device_sort_code");
		var sort_code1 = sort_codes[0];
		for (var i = 1; i < sort_codes.length; i++) {
			if(sort_codes[i]!=sort_code1){
				$.ligerDialog.error('提示：请选择相同设备类型的检验信息！');
				return;
			}
		}
		
		var check_types = Qm.getValuesByName("check_type");
		var check_type1 = check_types[0];
		for (var i = 1; i < check_types.length; i++) {
			if(check_types[i]!=check_type1){
				$.ligerDialog.error('提示：请选择相同检验类型的检验信息！');
				return;
			}
		}
		
		   top.$.dialog({
				width : 800, 
				height : 600, 
				lock : true, 
				title: "问题来源填写",
				content: 'url:app/flow/report/report_error_resource.jsp?ids='+ids
						+"&check_type="+check_type1,
				data : {"window" : window,"device_sort_code":sort_code1}
			});
		
		
	}

	function qustRList(){
		var flow_note_name = Qm.getValueByName("flow_note_name");
		var id = Qm.getValueByName("id");
		   top.$.dialog({
				width :800, 
				height : 600, 
				lock : true, 
				title: "问题来源填写",
				content: 'url:app/flow/report/report_error_resource_list.jsp?id='+id,
				data : {"window" : window,"flow_note_name":flow_note_name}
			});
		
		
	}

	function showmsg1() {
		$.ligerDialog.error('提示：检验信息没有对应的设备类型或者检验类型，请检查！');
	}
	 function showmsg2() {
		$.ligerDialog.error('提示：没有对应的设备类型和检验类型的问题来源 ，请检查！');
	}
	
	function submitAction() {
		Qm.refreshGrid();   
	}
	// 查看质量相关资料
	function showQuality() {
		var big_class = Qm.getValueByName("big_class_code").toString();	
		if(big_class==null||big_class==""){
			return;
		}
		top.$.dialog({
			width : 800, 
			height : 500, 
			lock : true, 
			title : "查看图片", 
			data : {"window" : window},
			cancel : true,
			content : 'url:app/qualitymanage/qualityFiles_list2.jsp?big_class=' + big_class+"000"
		});
	}
</script>
</head>
<body>
	<div class="item-tm" id="titleElement">
	    <div class="l-page-title">
			<div class="l-page-title-note">提示：列表数据项
				<font color="black">“黑色”</font>代表待录入或已退回待修改的报告，
				<font color="gray">“灰色”</font>代表相关部门核实设备注册信息，
				<font color="gray">“灰色”</font>代表成都市局验证，
				<font color="blue">“蓝色”</font>代表已录入的报告。
			</div>
		</div>
	</div>
	<qm:qm pageid="report_enter" script="false" singleSelect="false">
		<qm:param name="flow_note_id" value="${param.flow_num}" compare="=" />
		<qm:param name="fk_flow_index_id" value="${param.flowId}" compare="=" />
		<qm:param name="handler_id" value="<%=userId%>" compare="=" />
	</qm:qm>
	<script type="text/javascript">
	
	 Qm.config.columnsInfo.big_class.binddata=[{id:'1',text:'锅炉'},
	                                              {id:'2',text:'压力容器'},
	                                              {id:'3',text:'电梯'},
	                                              {id:'4',text:'起重机械'},
	                                              {id:'5',text:'厂（场）内机动车辆'},
	                                              {id:'6',text:'大型游乐设施'},
	                                              {id:'7',text:'压力管道元件'},
	                                              {id:'8',text:'压力管道'},
	                                              {id:'9',text:'客运索道'},
	                                              {id:'B',text:'部件'},
	                                              {id:'C',text:'材料'},
	                                              {id:'F',text:'安全附件及安全保护装置'}];
	</script>
</body>
</html>